<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Photon Realtime Bot Client</title>
    <style>
      /* Simple, modern styling without relying on external frameworks */
      body {
        margin: 0;
        padding: 0;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        background-color: #f9fafb;
        color: #1f2937;
      }
      .container {
        max-width: 640px;
        margin: 3rem auto;
        background-color: #ffffff;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        padding: 2rem 2.5rem;
      }
      h1 {
        margin-top: 0;
        margin-bottom: 1.5rem;
        font-size: 1.75rem;
        text-align: center;
        color: #111827;
      }
      .form-group {
        margin-bottom: 1rem;
      }
      .form-group label {
        display: block;
        margin-bottom: 0.25rem;
        font-weight: 600;
        font-size: 0.9rem;
      }
      .form-group input, .form-group select {
        width: 100%;
        padding: 0.5rem 0.75rem;
        border: 1px solid #d1d5db;
        border-radius: 4px;
        font-size: 1rem;
        color: #111827;
        background-color: #ffffff;
      }
      .form-group input:focus, .form-group select:focus {
        outline: none;
        border-color: #6b7280;
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.4);
      }
      .btn {
        display: block;
        width: 100%;
        padding: 0.75rem 1rem;
        font-size: 1rem;
        font-weight: 600;
        text-align: center;
        color: #ffffff;
        background-color: #10b981; /* emerald-500 */
        border: none;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.2s ease;
        margin-top: 0.5rem;
      }
      .btn:hover {
        background-color: #059669; /* emerald-600 */
      }
      .log-container {
        margin-top: 1.5rem;
        border: 1px solid #e5e7eb;
        border-radius: 4px;
        background-color: #f3f4f6;
        padding: 1rem;
        height: 240px;
        overflow-y: auto;
        font-size: 0.875rem;
        line-height: 1.4;
        white-space: pre-wrap;
      }
      .log-container strong {
        color: #111827;
      }

      .player-count {
        margin-top: 1rem;
        font-size: 1rem;
        font-weight: 600;
        text-align: center;
        color: #111827;
      }

      /* Informational text, used to display room default or actual max players */
      .info-text {
        margin-top: 0.5rem;
        font-size: 0.875rem;
        color: #6b7280;
        text-align: center;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Photon Realtime Bot Client</h1>
      <p style="margin-bottom: 1.5rem; text-align:center;">Enter your Photon credentials and room information. This client will connect to the Photon Cloud and join or create the specified room in the chosen region. It works with any Realtime gameâ€”you can adjust the room name and other parameters below.</p>

      <!-- Application ID -->
      <div class="form-group">
        <label for="appId">Photon App ID</label>
        <input id="appId" type="text" placeholder="Your Photon App ID" value="12166b2c-34e5-4b6e-8ae9-2cc5217f87cc">
      </div>

      <!-- App Version -->
      <div class="form-group">
        <label for="appVer">App Version</label>
        <input id="appVer" type="text" placeholder="e.g. 1.0" value="1.0">
      </div>

      <!-- Region -->
      <div class="form-group">
        <label for="region">Region</label>
        <select id="region">
          <option value="us" selected>US</option>
          <option value="eu">EU</option>
          <option value="asia">Asia</option>
          <option value="au">Australia</option>
          <option value="jp">Japan</option>
          <option value="sa">South America</option>
          <option value="ru">Russia</option>
        </select>
      </div>

      <!-- Join/Create mode -->
      <div class="form-group">
        <label for="joinMode">Room Mode</label>
        <select id="joinMode">
          <option value="join" selected>Join existing room</option>
          <option value="create">Create or join with custom settings</option>
        </select>
      </div>

      <!-- Default max players info (shown when joining existing room) -->
      <p id="defaultMaxPlayersInfo" class="info-text" style="display: none;">This game defaults to 10 players per room.</p>

      <!-- Room Name -->
      <div class="form-group">
        <label for="roomName">Room Name</label>
        <input id="roomName" type="text" placeholder="Room name (create or join)" value="1">
      </div>

      <!-- Max Players -->
      <!-- Custom settings (only visible when mode is set to create) -->
      <div id="customSettings">
        <div class="form-group">
          <label for="maxPlayers">Max Players</label>
          <input id="maxPlayers" type="number" min="1" max="20" value="4">
        </div>
        <div class="form-group">
          <label>
            <input id="isVisible" type="checkbox" checked> Make room visible
          </label>
        </div>
      </div>

      <button id="connectBtn" class="btn">Connect & Join Room</button>
      <!-- Leave button appears after joining; allows client to leave the room and disconnect -->
      <button id="leaveBtn" class="btn" style="background-color:#ef4444; display:none;">Leave Room</button>

      <!-- Player count display; hidden until connected and joined a room -->
      <div id="playerCountContainer" class="player-count" style="display: none;">Players in room: <span id="playerCount">0</span></div>

      <!-- Room max players info; hidden until after joining a room. Updated dynamically -->
      <p id="roomMaxPlayersInfo" class="info-text" style="display: none;"></p>

      <!-- Log output -->
      <div id="log" class="log-container" aria-label="Event Log"></div>
    </div>

    <!-- Photon JS SDK via CDN.  For bundlers, you can import photon-loadbalancing-ts from your node_modules. -->
    <script src="https://cdn.jsdelivr.net/npm/photon-javascript-sdk@1.0.0/lib/Photon-Javascript_SDK.min.js"></script>
    <script>
      // Utility: append messages to log container and auto-scroll to bottom
      function appendLog() {
        const logContainer = document.getElementById('log');
        logContainer.textContent += Array.from(arguments).join(' ') + '\n';
        logContainer.scrollTop = logContainer.scrollHeight;
      }

      // Global variables to track the current Photon client and its service interval.
      let currentClient = null;
      let serviceIntervalId = null;

      // Toggle visibility of custom settings based on selected room mode
      (function setupModeToggle() {
        const modeSelect = document.getElementById('joinMode');
        const custom     = document.getElementById('customSettings');
        const updateVisibility = function() {
          if (modeSelect.value === 'create') {
            custom.style.display = '';
          } else {
            custom.style.display = 'none';
          }
        };
        updateVisibility();
        modeSelect.addEventListener('change', updateVisibility);
      })();

      // Handle clicking the Connect button: establish a Photon client and join or create room.
      document.getElementById('connectBtn').addEventListener('click', function() {
        const appId    = document.getElementById('appId').value.trim();
        const appVer   = document.getElementById('appVer').value.trim() || '1.0';
        const region   = document.getElementById('region').value;
        const roomName = document.getElementById('roomName').value.trim() || '1';
        const maxPlayers = parseInt(document.getElementById('maxPlayers').value, 10) || 4;
        const isVisible  = document.getElementById('isVisible').checked;
        const joinMode = document.getElementById('joinMode').value;

        if (!appId) {
          appendLog('âš ï¸ Please provide a valid Photon App ID.');
          return;
        }

        // If there is an existing client connected, disconnect it cleanly before starting a new one.
        if (currentClient) {
          appendLog('ðŸ”„ Disconnecting existing clientâ€¦');
          try {
            currentClient.disconnect();
          } catch (e) {}
          if (serviceIntervalId) {
            clearInterval(serviceIntervalId);
            serviceIntervalId = null;
          }
          currentClient = null;
          // Hide the leave button and reset UI state since weâ€™re starting fresh
          const leaveBtn = document.getElementById('leaveBtn');
          leaveBtn.style.display = 'none';
          document.getElementById('connectBtn').style.display = 'block';
          const playerCountContainer = document.getElementById('playerCountContainer');
          playerCountContainer.style.display = 'none';
          document.getElementById('roomMaxPlayersInfo').style.display = 'none';
        }

        appendLog('ðŸ”Œ Connectingâ€¦');
        appendLog('App ID:', appId);
        appendLog('App Version:', appVer);
        appendLog('Region:', region);
        appendLog('Room:', roomName);
        if (joinMode === 'create') {
          appendLog('Max Players:', maxPlayers);
          appendLog('Visible:', isVisible);
        } else {
          appendLog('Using default room settings (max players and visibility)');
        }

        const { LoadBalancingClient, ConnectionProtocol, StatusCode } = Photon.LoadBalancing;
        const client = new LoadBalancingClient(appId, appVer, ConnectionProtocol.Ws);
        const playerCountContainer = document.getElementById('playerCountContainer');
        const playerCountEl = document.getElementById('playerCount');
        const roomMaxPlayersInfo = document.getElementById('roomMaxPlayersInfo');

        client.onStateChange = function(state) {
          appendLog('State changed â†’', LoadBalancingClient.StateToName(state));
          if (state === StatusCode.Connect) {
            appendLog('âœ… Connected to region master. Joining roomâ€¦');
            if (joinMode === 'create') {
              client.joinOrCreateRoom(roomName, {
                maxPlayers: maxPlayers,
                isVisible: isVisible
              });
            } else {
              client.joinRoom(roomName);
            }
          }
          if (state === StatusCode.Disconnect) {
            appendLog('âŒ Disconnected from Photon.');
            playerCountContainer.style.display = 'none';
            playerCountEl.textContent = '0';
            roomMaxPlayersInfo.style.display = 'none';
            roomMaxPlayersInfo.textContent = '';
            document.getElementById('leaveBtn').style.display = 'none';
            document.getElementById('connectBtn').style.display = 'block';
            currentClient = null;
            if (serviceIntervalId) {
              clearInterval(serviceIntervalId);
              serviceIntervalId = null;
            }
          }
        };
        client.onError = function(code, msg) {
          appendLog('âš ï¸ Error', code + ':', msg);
        };
        client.onJoinRoom = function() {
          appendLog('ðŸŽ‰ Joined room', roomName, 'as actor #', client.myActorNumber);
          document.getElementById('leaveBtn').style.display = 'block';
          document.getElementById('connectBtn').style.display = 'none';
          const count = Object.keys(client.myRoomActors || {}).length;
          playerCountEl.textContent = count;
          playerCountContainer.style.display = 'block';
          try {
            const room = client.myRoom();
            const maxPlayersValue = room && typeof room.maxPlayers === 'number' ? room.maxPlayers : 0;
            if (maxPlayersValue > 0) {
              roomMaxPlayersInfo.textContent = 'Max players allowed: ' + maxPlayersValue;
            } else {
              roomMaxPlayersInfo.textContent = 'No max players limit set for this game.';
            }
            roomMaxPlayersInfo.style.display = 'block';
          } catch (e) {
            roomMaxPlayersInfo.style.display = 'none';
            roomMaxPlayersInfo.textContent = '';
          }
        };
        client.onActorJoin = function(actor) {
          appendLog('ðŸ‘¤ Player joined:', actor.actorNr);
          const count = Object.keys(client.myRoomActors || {}).length;
          playerCountEl.textContent = count;
        };
        client.onActorLeave = function(actor) {
          appendLog('ðŸ‘‹ Player left:', actor.actorNr);
          const count = Object.keys(client.myRoomActors || {}).length;
          playerCountEl.textContent = count;
        };

        client.connectToRegionMaster(region);
        serviceIntervalId = setInterval(function() {
          client.service();
        }, 50);
        currentClient = client;
      });

      // Leave button: disconnect from Photon and reset UI
      document.getElementById('leaveBtn').addEventListener('click', function() {
        if (!currentClient) return;
        appendLog('ðŸšª Leaving roomâ€¦');
        try {
          currentClient.disconnect();
        } catch (e) {}
        if (serviceIntervalId) {
          clearInterval(serviceIntervalId);
          serviceIntervalId = null;
        }
        currentClient = null;
        document.getElementById('leaveBtn').style.display = 'none';
        document.getElementById('connectBtn').style.display = 'block';
        document.getElementById('playerCountContainer').style.display = 'none';
        document.getElementById('playerCount').textContent = '0';
        const infoEl = document.getElementById('roomMaxPlayersInfo');
        infoEl.style.display = 'none';
        infoEl.textContent = '';
        appendLog('âœ… Left room and disconnected.');
      });
    </script>
  </body>
</html>
